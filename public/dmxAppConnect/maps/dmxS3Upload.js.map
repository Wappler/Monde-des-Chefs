{"version":3,"sources":["actions/s3.js","components/s3Upload.js","components/s3UploadMulti.js"],"names":["dmx","Actions","s3.upload","options","inp","this","parse","input","url","file","document","getElementById","files","Promise","resolve","reject","xhr","XMLHttpRequest","onerror","onabort","ontimeout","onload","open","setRequestHeader","type","send","Component","initialData","data","state","idle","ready","uploading","done","uploadProgress","position","total","percent","lastError","status","message","response","attributes","String","default","prop","accept","autoupload","Boolean","methods","abort","reset","select","click","upload","events","start","Event","error","success","ProgressEvent","render","node","$node","addEventListener","onDragover","bind","onDrop","onClick","createElement","props","onChange","onAbort","onError","onTimeout","onLoad","onProgress","$parse","update","e","stopPropagation","preventDefault","dataTransfer","dropEffect","items","length","updateFile","target","value","set","dispatchEvent","console","responseText","size","loaded","Math","ceil","lengthComputable","_validate","split","some","charAt","name","match","RegExp","test","replace","toLowerCase","info","date","lastModified","Date","lastModifiedDate","toISOString","dataUrl","indexOf","reader","FileReader","result","requestUpdate","readAsDataURL","upload2","encodeURIComponent","JSON","acl","substr","err","thumbs","thumb-width","Number","thumb-height","remove","id","startUpload","multiple","maxRetries","uploads","ii","isUploading","find","nextRetry","retries","webkitGetAsEntry","updateFilesFromItems","updateFiles","uploaded","setTimeout","upload3","statusText","resize","src","cb","img","tWidth","parseInt","tHeight","canvas","ctx","getContext","sWidth","width","sHeight","height","min","tRatio","sx","sy","drawImage","toDataURL","push","concat","array","forEach","item","entry","isFile","getAsFile","isDirectory","updateFilesFromDirectory","kind","directory","path","createReader","readEntries","entries","fullPath","warn","index","findIndex","splice","log"],"mappings":"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","file":"../dmxS3Upload/dmxS3Upload.js","sourcesContent":["dmx.Actions({\r\n\r\n    's3.upload': function(options) {\r\n        var inp = this.parse(options.input);\r\n        var url = this.parse(options.url);\r\n        var file = document.getElementById(inp).files[0];\r\n        \r\n        return new Promise(function(resolve, reject) {\r\n            var xhr = new XMLHttpRequest();\r\n\r\n            xhr.onerror = reject;\r\n            xhr.onabort = reject;\r\n            xhr.ontimeout = reject;\r\n            xhr.onload = resolve;\r\n\r\n            xhr.open('PUT', url);\r\n            xhr.setRequestHeader('Content-Type', file.type);\r\n            xhr.send(file);\r\n        });\r\n    }\r\n\r\n})","dmx.Component('s3-upload', {\r\n\r\n    initialData: {\r\n        data: null,\r\n        file: null,\r\n        state: {\r\n            idle: true,\r\n            ready: false,\r\n            uploading: false,\r\n            done: false\r\n        },\r\n        uploadProgress: {\r\n            position: 0,\r\n            total: 0,\r\n            percent: 0\r\n        },\r\n        lastError: {\r\n            status: 0,\r\n            message: '',\r\n            response: null\r\n        }\r\n    },\r\n\r\n    attributes: {\r\n        url: {\r\n            type: String,\r\n            default: null\r\n        },\r\n\r\n        prop: {\r\n            type: String,\r\n            default: 'url'\r\n        },\r\n\r\n        accept: {\r\n            type: String,\r\n            default: null\r\n        },\r\n\r\n        autoupload: {\r\n            type: Boolean,\r\n            default: false\r\n        }\r\n    },\r\n\r\n    methods: {\r\n        abort: function() {\r\n            this.abort();\r\n        },\r\n\r\n        reset: function() {\r\n            this.reset();\r\n        },\r\n\r\n        select: function() {\r\n            this.input.click();\r\n        },\r\n\r\n        upload: function() {\r\n            this.upload();\r\n        }\r\n    },\r\n\r\n    events: {\r\n        start: Event, // when starting an ajax call\r\n        done: Event, // when ajax call completed (success and error)\r\n        error: Event, // server error or javascript error (json parse or network transport) or timeout error\r\n        abort: Event, // ajax call was aborted\r\n        success: Event, // successful ajax call,\r\n        upload: ProgressEvent // on upload progress\r\n    },\r\n\r\n    render: function(node) {\r\n        this.$node.addEventListener('dragover', this.onDragover.bind(this));\r\n        this.$node.addEventListener('drop', this.onDrop.bind(this));\r\n        this.$node.addEventListener('click', this.onClick.bind(this));\r\n        \r\n        this.input = document.createElement('input');\r\n        this.input.type = 'file';\r\n        this.input.accept = this.props.accept || '*/*';\r\n        this.input.addEventListener('change', this.onChange.bind(this));\r\n\r\n        this.xhr = new XMLHttpRequest();\r\n        this.xhr.addEventListener('abort', this.onAbort.bind(this));\r\n        this.xhr.addEventListener('error', this.onError.bind(this));\r\n        this.xhr.addEventListener('timeout', this.onTimeout.bind(this));\r\n        this.xhr.addEventListener('load', this.onLoad.bind(this));\r\n        this.xhr.upload.addEventListener('progress', this.onProgress.bind(this));\r\n\r\n        this.$parse();\r\n    },\r\n\r\n    update: function(props) {\r\n        if (this.props.accept != props.accept) {\r\n            this.input.accept = this.props.accept || '*/*';\r\n        }\r\n    },\r\n\r\n    onDragover: function(e) {\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n\r\n        e.dataTransfer.dropEffect = e.dataTransfer.items.length == 1 ? 'copy' : 'none';\r\n    },\r\n\r\n    onDrop: function(e) {\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n\r\n        if (e.dataTransfer.files.length == 1) {\r\n            this.updateFile(e.dataTransfer.files[0]);\r\n        }\r\n    },\r\n\r\n    onClick: function(e) {\r\n        this.input.click();\r\n    },\r\n\r\n    onChange: function(e) {\r\n        this.updateFile(e.target.files[0]);\r\n        this.input.value = '';\r\n        this.input.type = '';\r\n        this.input.type = 'file';\r\n    },\r\n\r\n    onAbort: function(e) {\r\n        this.set({\r\n            data: null,\r\n            state: {\r\n                idle: false,\r\n                ready: true,\r\n                uploading: false,\r\n                done: false\r\n            },\r\n            uploadProgress: {\r\n                position: 0,\r\n                total: 0,\r\n                percent: 0\r\n            }\r\n        });\r\n\r\n        this.dispatchEvent('abort');\r\n        this.dispatchEvent('done');\r\n    },\r\n\r\n    onError: function(e) {\r\n        if (e instanceof ProgressEvent) {\r\n            e = 'Network error, perhaps no CORS set';\r\n        }\r\n\r\n        this.set({\r\n            data: null,\r\n            state: {\r\n                idle: false,\r\n                ready: true,\r\n                uploading: false,\r\n                done: false\r\n            },\r\n            uploadProgress: {\r\n                position: 0,\r\n                total: 0,\r\n                percent: 0\r\n            },\r\n            lastError: {\r\n                status: 0,\r\n                message: e,\r\n                response: null\r\n            }\r\n        });\r\n\r\n        console.error(e);\r\n\r\n        this.dispatchEvent('error');\r\n        this.dispatchEvent('done');\r\n    },\r\n\r\n    onTimeout: function(e) {\r\n        this.onError('Execution timeout');\r\n    },\r\n\r\n    onLoad: function(e) {\r\n        if (this.xhr.status >= 400) {\r\n            this.onError(this.xhr.responseText);\r\n        } else {\r\n            this.set({\r\n                state: {\r\n                    idle: false,\r\n                    ready: false,\r\n                    uploading: false,\r\n                    done: true\r\n                },\r\n                uploadProgress: {\r\n                    position: this.file.size,\r\n                    total: this.file.size,\r\n                    percent: 100\r\n                }\r\n            });\r\n\r\n            this.dispatchEvent('success');\r\n            this.dispatchEvent('done');\r\n        }\r\n    },\r\n\r\n    onProgress: function(e) {\r\n        this.set({\r\n            state: {\r\n                idle: false,\r\n                ready: false,\r\n                uploading: true,\r\n                done: false\r\n            },\r\n            uploadProgress: {\r\n                position: e.loaded,\r\n                total: this.file.size,\r\n                percent: Math.ceil(e.loaded / e.total * 100)\r\n            }\r\n        });\r\n\r\n        this.dispatchEvent('upload', {\r\n            lengthComputable: e.lengthComputable,\r\n            loaded: e.loaded,\r\n            total: e.total\r\n        });\r\n    },\r\n\r\n    _validate: function(file) {\r\n        if (this.props.accept) {\r\n            return this.props.accept.split(/\\s*,\\s*/g).some(function(type) {\r\n                if (type.charAt(0) == '.') {\r\n                    if (file.name.match(new RegExp('\\\\' + type + '$', 'i'))) {\r\n                        return true;\r\n                    }\r\n                } else if (/(audio|video|image)\\/\\*/i.test(type)) {\r\n                    if (file.type.match(new RegExp('^' + type.replace(/\\*/g, '.*') + '$', 'i'))) {\r\n                        return true;\r\n                    }\r\n                } else {\r\n                    if (file.type.toLowerCase() == type.toLowerCase()) {\r\n                        return true;\r\n                    }\r\n                }\r\n\r\n                return false;\r\n            });\r\n        }\r\n\r\n        return true;\r\n    },\r\n\r\n    updateFile: function(file) {\r\n        if (!this._validate(file)) {\r\n            return;\r\n        }\r\n        \r\n        var info = {\r\n            name: file.name,\r\n            size: file.size,\r\n            type: file.type,\r\n            date: (file.lastModified ? new Date(file.lastModified) : file.lastModifiedDate).toISOString(),\r\n            dataUrl: null\r\n        };\r\n\r\n        if (file.type.indexOf('image/') !== -1 && !file.reader) {\r\n            file.reader = new FileReader();\r\n\r\n            file.reader.onload = function(e) {\r\n                info.dataUrl = e.target.result;\r\n                dmx.requestUpdate();\r\n            }.bind(this);\r\n\r\n            file.reader.readAsDataURL(file);\r\n        }\r\n\r\n        this.file = file;\r\n\r\n        this.set({\r\n            file: info,\r\n            state: {\r\n                idle: false,\r\n                ready: true,\r\n                uploading: false,\r\n                done: false\r\n            }\r\n        });\r\n\r\n        if (this.props.autoupload) {\r\n            this.upload();\r\n        }\r\n    },\r\n\r\n    abort: function() {\r\n        this.xhr.abort();\r\n    },\r\n\r\n    reset: function() {\r\n        this.abort();\r\n        this.file = null;\r\n        this.set({\r\n            data: null,\r\n            file: null,\r\n            state: {\r\n                idle: true,\r\n                ready: false,\r\n                uploading: false,\r\n                done: false\r\n            },\r\n            uploadProgress: {\r\n                position: 0,\r\n                total: 0,\r\n                percent: 0\r\n            },\r\n            lastError: {\r\n                status: 0,\r\n                message: '',\r\n                response: null\r\n            }\r\n        });\r\n    },\r\n\r\n    upload: function() {\r\n        if (!this.props.url) {\r\n            this.onError('No url attribute is set');\r\n            return;\r\n        }\r\n\r\n        this.set({\r\n            state: {\r\n                idle: false,\r\n                ready: false,\r\n                uploading: true,\r\n                done: false\r\n            }\r\n        });\r\n\r\n        this.dispatchEvent('start');\r\n\r\n        var xhr = new XMLHttpRequest();\r\n        xhr.onabort = this.onAbort.bind(this);\r\n        xhr.onerror = this.onError.bind(this);\r\n        xhr.onload = this.upload2.bind(this, xhr);\r\n        xhr.open('GET', this.props.url + '?name=' + encodeURIComponent(this.file.name));\r\n        xhr.send();\r\n    },\r\n\r\n    upload2: function(xhr) {\r\n        try {\r\n            var data = JSON.parse(xhr.responseText);\r\n            var url = data[this.props.prop]\r\n            this.set('data', data);\r\n            this.xhr.open('PUT', url);\r\n            this.xhr.setRequestHeader('Content-Type', this.file.type);\r\n            if (url.indexOf('x-amz-acl=') != -1) {\r\n                // could be improved\r\n                var acl = url.substr(url.indexOf('x-amz-acl=') + 10);\r\n                if (acl.indexOf('&') != -1) acl = acl.substr(0, acl.indexOf('&'));\r\n                this.xhr.setRequestHeader('x-amz-acl', acl);\r\n            }\r\n            this.xhr.send(this.file);\r\n        } catch (err) {\r\n            this.onError(err);\r\n        }\r\n    }\r\n\r\n});","dmx.Component('s3-upload-multi', {\r\n\r\n    initialData: {\r\n        data: null,\r\n        files: [],\r\n        state: {\r\n            idle: true,\r\n            ready: false,\r\n            uploading: false\r\n        },\r\n        lastError: ''\r\n    },\r\n\r\n    attributes: {\r\n        url: {\r\n            type: String,\r\n            default: null\r\n        },\r\n\r\n        prop: {\r\n            type: String,\r\n            default: 'url'\r\n        },\r\n\r\n        accept: {\r\n            type: String,\r\n            default: null\r\n        },\r\n\r\n        autoupload: {\r\n            type: Boolean,\r\n            default: false\r\n        },\r\n\r\n        thumbs: {\r\n            type: String,\r\n            default: 'true'\r\n        },\r\n\r\n        'thumb-width': {\r\n            type: Number,\r\n            default: 100\r\n        },\r\n\r\n        'thumb-height': {\r\n            type: Number,\r\n            default: 100\r\n        }\r\n    },\r\n\r\n    methods: {\r\n        abort: function() {\r\n            this.abort();\r\n        },\r\n\r\n        reset: function() {\r\n            this.reset();\r\n        },\r\n\r\n        select: function() {\r\n            this.input.click();\r\n        },\r\n\r\n        remove: function(id) {\r\n            this.remove(id);\r\n        },\r\n\r\n        upload: function() {\r\n            this.startUpload();\r\n        }\r\n    },\r\n\r\n    events: {\r\n        start: Event, // when starting an ajax call\r\n        done: Event, // when ajax call completed (success and error)\r\n        error: Event, // server error or javascript error (json parse or network transport) or timeout error\r\n        abort: Event, // ajax call was aborted\r\n        success: Event // successful ajax call\r\n    },\r\n\r\n    render: function(node) {\r\n        this.$node.addEventListener('dragover', this.onDragover.bind(this));\r\n        this.$node.addEventListener('drop', this.onDrop.bind(this));\r\n        this.$node.addEventListener('click', this.onClick.bind(this));\r\n        \r\n        this.input = document.createElement('input');\r\n        this.input.type = 'file';\r\n        this.input.multiple = true;\r\n        this.input.accept = this.props.accept || '*/*';\r\n        this.input.addEventListener('change', this.onChange.bind(this));\r\n\r\n        this.maxRetries = 5;\r\n        this.uploads = [];\r\n        this.ii = 0;\r\n\r\n        this.$parse();\r\n    },\r\n\r\n    update: function(props) {\r\n        if (this.props.accept != props.accept) {\r\n            this.input.accept = this.props.accept || '*/*';\r\n        }\r\n\r\n        if (this.uploads.length) {\r\n            if (this.isUploading()) {\r\n                this.set('state', {\r\n                    idle: false,\r\n                    ready: false,\r\n                    uploading: true\r\n                });\r\n            } else {\r\n                this.set('state', {\r\n                    idle: false,\r\n                    ready: true,\r\n                    uploading: false\r\n                });\r\n            }\r\n        } else {\r\n            this.set('state', {\r\n                idle: true,\r\n                ready: false,\r\n                uploading: false\r\n            });\r\n        }\r\n    },\r\n\r\n    isUploading: function() {\r\n        return !!this.uploads.find(function(upload) {\r\n            return upload.info.uploading;\r\n        }, this);\r\n    },\r\n\r\n    nextRetry: function(retries) {\r\n        return (this.maxRetries - retries + 1) * 3000;\r\n    },\r\n\r\n    _validate: function(file) {\r\n        // simple validation based on accept to filter out unallowed files\r\n        if (this.props.accept) {\r\n            return this.props.accept.split(/\\s*,\\s*/g).some(function(type) {\r\n                if (type.charAt(0) == '.') {\r\n                    if (file.name.match(new RegExp('\\\\' + type + '$', 'i'))) {\r\n                        return true;\r\n                    }\r\n                } else if (/(audio|video|image)\\/\\*/i.test(type)) {\r\n                    if (file.type.match(new RegExp('^' + type.replace(/\\*/g, '.*') + '$', 'i'))) {\r\n                        return true;\r\n                    }\r\n                } else {\r\n                    if (file.type.toLowerCase() == type.toLowerCase()) {\r\n                        return true;\r\n                    }\r\n                }\r\n\r\n                return false;\r\n            });\r\n        }\r\n\r\n        return true;\r\n    },\r\n\r\n    onDragover: function(e) {\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n\r\n        e.dataTransfer.dropEffect = 'copy';\r\n    },\r\n\r\n    onDrop: function(e) {\r\n        e.stopPropagation();\r\n        e.preventDefault();\r\n\r\n        if (!e.dataTransfer) return;\r\n\r\n        var files = e.dataTransfer.files;\r\n\r\n        if (files.length) {\r\n            var items = e.dataTransfer.items;\r\n\r\n            if (items && items.length && items[0].webkitGetAsEntry) {\r\n                this.updateFilesFromItems(items);\r\n            } else {\r\n                this.updateFiles(files);\r\n            }\r\n        }\r\n    },\r\n\r\n    onClick: function(e) {\r\n        this.input.click();\r\n    },\r\n\r\n    onChange: function(e) {\r\n        this.updateFiles(e.target.files);\r\n        this.input.value = '';\r\n        this.input.type = '';\r\n        this.input.type = 'file';\r\n    },\r\n\r\n    onAbort: function(upload, e) {\r\n        upload.info.uploading = false;\r\n        upload.info.uploaded = 0;\r\n        upload.info.percent = 0;\r\n        \r\n        dmx.requestUpdate();\r\n\r\n        if (!this.isUploading()) {\r\n            this.dispatchEvent('abort');\r\n            this.dispatchEvent('done');\r\n        }\r\n    },\r\n\r\n    onError: function(upload, e) {\r\n        if (upload.url && upload.retries) {\r\n            setTimeout(this.upload3.bind(this, upload), this.nextRetry(upload.retries--));\r\n            return;\r\n        }\r\n        \r\n        if (e instanceof ProgressEvent) {\r\n            e = 'Network error, perhaps no CORS set';\r\n        } else {\r\n            e = e.message ||  e;\r\n        }\r\n\r\n        this.set('lastError', e);\r\n\r\n        upload.info.uploading = false;\r\n        upload.info.uploaded = 0;\r\n        upload.info.percent = 0;\r\n        upload.info.error = e;\r\n\r\n        dmx.requestUpdate();\r\n\r\n        if (!this.isUploading()) {\r\n            this.dispatchEvent('error');\r\n            this.dispatchEvent('done');\r\n        }\r\n    },\r\n\r\n    onTimeout: function(upload, e) {\r\n        this.onError(upload, 'Execution timeout');\r\n    },\r\n\r\n    onLoad: function(upload, e) {\r\n        if (upload.xhr.status >= 500 || upload.xhr.status == 429) {\r\n            if (upload.retries) {\r\n                setTimeout(this.upload3.bind(this, upload), this.nextRetry(upload.retries--));\r\n            } else {\r\n                this.onError(upload, upload.xhr.responseText || upload.xhr.statusText);\r\n            }\r\n        } else if (upload.xhr.status >= 400) {\r\n            this.onError(upload, upload.xhr.responseText || upload.xhr.statusText);\r\n        } else {\r\n            this.remove(upload.file.id);\r\n\r\n            dmx.requestUpdate();\r\n\r\n            if (!this.isUploading()) {\r\n                if (!this.uploads.length) {\r\n                    this.dispatchEvent('success');\r\n                } else {\r\n                    this.dispatchEvent('error');\r\n                }\r\n                this.dispatchEvent('done');\r\n            }\r\n        }\r\n    },\r\n\r\n    onProgress: function(upload, e) {\r\n        upload.info.uploaded = e.loaded;\r\n        upload.info.percent = e.lengthComputable ? Math.ceil(e.loaded / e.total * 100) : 0;\r\n\r\n        dmx.requestUpdate();\r\n    },\r\n\r\n    resize: function(src, cb) {\r\n        var img = document.createElement('img');\r\n\r\n        var tWidth = parseInt(this.props['thumb-width']) || 100;\r\n        var tHeight = parseInt(this.props['thumb-height']) || 100;\r\n\r\n        img.onload = function() {\r\n            var canvas = document.createElement('canvas');\r\n            var ctx = canvas.getContext('2d');\r\n\r\n            var sWidth = img.width;\r\n            var sHeight = img.height;\r\n\r\n            tWidth = Math.min(tWidth, sWidth);\r\n            tHeight = Math.min(tHeight, sHeight);\r\n\r\n            var sRatio = sWidth / sHeight;\r\n            var tRatio = tWidth / tHeight;\r\n\r\n            if (sWidth > tWidth || sHeight > tHeight) {\r\n                if (sRatio > tRatio) {\r\n                    sWidth = sHeight * tRatio;\r\n                } else {\r\n                    sHeight = sWidth / tRatio;\r\n                }\r\n            }\r\n\r\n            canvas.width = tWidth;\r\n            canvas.height = tHeight;\r\n\r\n            var sx = (img.width - sWidth) / 2;\r\n            var sy = (img.height - sHeight) / 2;\r\n\r\n            ctx.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, tWidth, tHeight);\r\n\r\n            cb(canvas.toDataURL());\r\n        };\r\n        \r\n        img.src = src;\r\n    },\r\n\r\n    updateFile: function(file) {\r\n        if (!this._validate(file)) {\r\n            return;\r\n        }\r\n\r\n        file.id = ++this.ii;\r\n\r\n        var info = {\r\n            id: file.id,\r\n            name: file.name,\r\n            size: file.size,\r\n            type: file.type,\r\n            date: (file.lastModified ? new Date(file.lastModified) : file.lastModifiedDate).toISOString(),\r\n            data: null,\r\n            uploading: false,\r\n            uploaded: 0,\r\n            percent: 0,\r\n            ready: false,\r\n            error: null,\r\n            dataUrl: null\r\n        };\r\n\r\n        if (file.type.indexOf('image/') !== -1 && !file.reader) {\r\n            file.reader = new FileReader();\r\n\r\n            file.reader.onload = function(e) {\r\n                info.dataUrl = e.target.result;\r\n                \r\n                if (this.props.thumbs) {\r\n                    this.resize(info.dataUrl, function(dataUrl) {\r\n                        info.dataUrl = dataUrl;\r\n                        info.ready = true;\r\n\r\n                        dmx.requestUpdate();\r\n                    })\r\n                } else {\r\n                    info.ready = true;\r\n                }\r\n\r\n                dmx.requestUpdate();\r\n            }.bind(this);\r\n\r\n            file.reader.readAsDataURL(file);\r\n        } else {\r\n            info.ready = true;\r\n        }\r\n\r\n        var upload = {\r\n            retries: this.maxRetries,\r\n            info: info,\r\n            file: file,\r\n            xhr: null\r\n        };\r\n\r\n        this.uploads.push(upload);\r\n\r\n        this.set({\r\n            files: this.data.files.concat([info]),\r\n            state: {\r\n                idle: false,\r\n                ready: true,\r\n                uploading: false,\r\n                done: false\r\n            }\r\n        });\r\n\r\n        if (this.props.autoupload) {\r\n            if (!this.isUploading()) {\r\n                this.dispatchEvent('start');\r\n            }\r\n\r\n            this.upload(upload);\r\n        }\r\n    },\r\n\r\n    updateFiles: function(files) {\r\n        dmx.array(files).forEach(function(file) {\r\n            this.updateFile(file);\r\n        }, this);\r\n    },\r\n\r\n    updateFilesFromItems: function(items) {\r\n        dmx.array(items).forEach(function(item) {\r\n            var entry;\r\n\r\n            if (item.webkitGetAsEntry && (entry = item.webkitGetAsEntry())) {\r\n                if (entry.isFile) {\r\n                    this.updateFile(item.getAsFile());\r\n                } else if (entry.isDirectory) {\r\n                    this.updateFilesFromDirectory(entry);\r\n                }\r\n            } else if (item.getAsFile) {\r\n                if (!item.kind || item.kind == 'file') {\r\n                    this.updateFile(item.getAsFile());\r\n                }\r\n            }\r\n        }, this);\r\n    },\r\n\r\n    updateFilesFromDirectory: function(directory, path) {\r\n        var reader = directory.createReader();\r\n        var readEntries = function() {\r\n            reader.readEntries(function(entries) {\r\n                if (entries.length) {\r\n                    entries.forEach(function(entry) {\r\n                        if (entry.isFile) {\r\n                            entry.file(function(file) {\r\n                                file.fullPath = path + '/' + file.name;\r\n                                this.updateFile(file);\r\n                            }.bind(this));\r\n                        } else if (entry.isDirectory) {\r\n                            this.updateFilesFromDirectory(entry, path + '/' + entry.name);\r\n                        }\r\n                    }, this);\r\n                }\r\n\r\n                readEntries();\r\n            }.bind(this), function(err) {\r\n                console.warn(err);\r\n            }.bind(this));\r\n        }.bind(this);\r\n\r\n        readEntries();\r\n    },\r\n\r\n    abort: function() {\r\n        this.uploads.forEach(function(upload) {\r\n            if (upload.xhr) upload.xhr.abort();\r\n        });\r\n    },\r\n\r\n    reset: function() {\r\n        this.abort();\r\n\r\n        this.uploads = [];\r\n\r\n        this.set({\r\n            data: null,\r\n            files: [],\r\n            state: {\r\n                idle: true,\r\n                ready: false,\r\n                uploading: false\r\n            },\r\n            lastError: ''\r\n        });\r\n    },\r\n\r\n    remove: function(id) {\r\n        var index = this.uploads.findIndex(function(upload) {\r\n            return upload.file.id == id;\r\n        });\r\n\r\n        if (index != -1) {\r\n            if (this.uploads[index].xhr) {\r\n                this.uploads[index].xhr.abort();\r\n            }\r\n            this.uploads.splice(index, 1);\r\n            this.data.files.splice(index, 1);\r\n            dmx.requestUpdate();\r\n        }\r\n    },\r\n\r\n    startUpload: function() {\r\n        this.dispatchEvent('start');\r\n\r\n        this.uploads.forEach(function(upload) {\r\n            this.upload(upload);\r\n        }, this);\r\n    },\r\n\r\n    upload: function(upload) {\r\n        if (upload.info && upload.info.uploading) return;\r\n\r\n        if (!this.props.url) {\r\n            this.onError('No url attribute is set');\r\n            return;\r\n        }\r\n\r\n        this.set({\r\n            state: {\r\n                idle: false,\r\n                ready: false,\r\n                uploading: true,\r\n                done: false\r\n            }\r\n        });\r\n\r\n        upload.info.uploading = true;\r\n        \r\n        dmx.requestUpdate();\r\n\r\n        upload.xhr = new XMLHttpRequest();\r\n        upload.xhr.onabort = this.onAbort.bind(this, upload);\r\n        upload.xhr.onerror = this.onError.bind(this, upload);\r\n        upload.xhr.ontimeout = this.onTimeout.bind(this, upload);\r\n        upload.xhr.onload = this.upload2.bind(this, upload);\r\n        upload.xhr.open('GET', this.props.url + '?name=' + encodeURIComponent(upload.file.name));\r\n        upload.xhr.send();\r\n    },\r\n\r\n    upload2: function(upload) {\r\n        try {\r\n            upload.info.data = JSON.parse(upload.xhr.responseText);\r\n            upload.url = upload.info.data[this.props.prop];\r\n            upload.xhr.onload = this.onLoad.bind(this, upload);\r\n            upload.xhr.upload.addEventListener('progress', this.onProgress.bind(this, upload));\r\n            upload.xhr.setRequestHeader('Content-Type', upload.file.type);\r\n            if (url.indexOf('x-amz-acl=') != -1) {\r\n                // could be improved\r\n                var acl = url.substr(url.indexOf('x-amz-acl=') + 10);\r\n                if (acl.indexOf('&') != -1) acl = acl.substr(0, acl.indexOf('&'));\r\n                upload.xhr.setRequestHeader('x-amz-acl', acl);\r\n            }\r\n            this.upload3(upload);\r\n        } catch (err) {\r\n            this.onError(upload, err);\r\n        }\r\n    },\r\n\r\n    upload3: function(upload) {\r\n        try {\r\n            upload.xhr.open('PUT', upload.url);\r\n            upload.xhr.send(upload.file);\r\n        } catch (err) {\r\n            if (upload.retries) {\r\n                console.log('Retry upload', upload);\r\n                setTimeout(this.upload3.bind(this, upload), this.nextRetry(upload.retries--));\r\n            } else {\r\n                console.log('Error in upload', upload, err);\r\n                this.onError(upload, err);\r\n            }\r\n        }\r\n    }\r\n\r\n});"]}